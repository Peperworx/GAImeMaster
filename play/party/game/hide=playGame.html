<html>
    <head>
        
        <link rel="stylesheet" href="/static/bootstrap-4.3.1-dist/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="/static/w3.css">
        <title>play | gAImeMaster</title>
        <link rel="stylesheet" href="/static/noty/lib/noty.css">
        <link rel="stylesheet"  href="/static/noty/lib/themes/metroui.css" />
        <link rel="stylesheet"  href="/static/noty/lib/themes/mint.css" />
        <link rel="stylesheet" href="/static/jquery-ui/jquery-ui.min.css">
        <style>
        html,body {
            margin:0;
            height:100%;
            width:100%;
        }
        #chat {
            list-style: none;
            padding:1px;
            width:100%;
            height:70%;
            overflow: scroll;
        }
        .welcome {
            font-size:1em;
            width:100%;
        }
        #chatform {
            width:100%;
            top:100%;
            bottom:0px;
        }
        #chatbox {
            width:100%;
        }
        #chatContainer {
            background-color:white;
            width:20%;
            min-width:20%;
            margin:2px;
            height:50%;
            min-height:50%;
            resize: both;
            overflow:auto;
            border: 2px solid lightgray;
        }
        #partyStatus {
            background-color:white;
            width:20%;
            min-width:20%;
            margin:2px;
            height:50%;
            min-height:50%;
            resize: both;
            overflow:auto;
            border: 2px solid lightgray;
        }
        .username {
            margin-right:5px;
        }
        .bar:after {
            content:"\007C";
        }
        .message {
            margin-left:5px;
        }
        #chatHeader {
            padding-bottom:5px;
            border-bottom: 1px solid lightgray;
        }
        #partyHeader {
            padding-bottom:5px;
            border-bottom: 1px solid lightgray;
        }
        #mainrow {
            height:100%;
        }
        #players {
            list-style: none;
        }
        #players li {
            padding:5px;
        }
        #players li .playeruname {
            margin-right:2px;
            display:none;
        }
        .charactername {
            padding-left:5px;
        }
        .charactername::after{
            content:"  ";
        }
        ins{color:#777;text-decoration:none}
        </style>
    </head>
    <body onunload="ex()">
        <a href="/play" class="w3-button w3-black w3-hover-grey">Home</a>
        <div class="container-fluid">
            <div id="mainrow" class="row">
                <div id="chatContainer" class="col-">
                    <h4 id="chatHeader" class="w3-center">Chat</h4>
                    <ul id="chat" class="">
                        <li><span class="welcome">Welcome To Beginning of chat!</span></li>
                    </ul>
                    <form id="chatform">
                        <input type="text" id="chatbox" placeholder="Type your message here...">
                    </form>
                </div>
                <div id="partyStatus" class="col-">
                    <h4 id="partyHeader" class="w3-center">Party Status</h4>
                    <ul id="players" class="">

                    </ul>
            <div class="row">
        </div>
        </div>

        <script src="/static/jquery.js"></script>
        <script src="/static/js.cookie-2.2.0.min.js"></script>
        <script src="/static/bootstrap-4.3.1-dist/js/bootstrap.js"></script>
        <script src="/static/noty/lib/noty.js"></script>
        <script src="/static/bootbox.all.min.js"></script>
        <script src="/static/socket.io.js"></script>
        <script src="/static/jquery-ui/jquery-ui.min.js"></script>
        <script src="/static/touchpunch.js"></script>
        <script>
            function findGetParameter(parameterName) {
            var result = null,
            tmp = [];
            location.search
                .substr(1)
                .split("&")
                .forEach(function (item) {
                  tmp = item.split("=");
                  if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
                });
            return result;
            }
            var players = []
            var id = "{{ id }}";
            var charid = findGetParameter("charid")
            var socket = io("http://"+location.host+":3435");
            var name = Cookies.get("username")
            socket.emit("checkIn", Cookies.get("username"));
            socket.emit("room",id);
            socket.emit("selectCharacter",{"UNAME":Cookies.get("username"),"CHARID":charid})
            socket.emit("joinGame", {"ID":id,"UNAME":Cookies.get("username"), "CHARID":charid})
            $("#chatform").submit(function(event){
                event.preventDefault();
                event.stopPropagation();
                socket.emit("sendChat", {"partyID":id,"UNAME":name,"message":$("#chatbox").val()});
                $("#chatbox").val("");
            });
            socket.on("newMsg", function(data){
                $("#chat").append("<li class='chatItem'><span class='username'>"+data["UNAME"]+"</span><span class='bar'></span><span class='message'>"+data["message"]+"</span></li>");
            });


            $.get("/users/getCharacters.py?username="+Cookies.get("username"), function(data){
                data = JSON.parse(data)
                for(i=0; i<data.length; i++){
                    if(data[i]["id"] == charid){
                        name = data[i]["name"]
                        break;
                    }
                }
            });




            function getCharacterPlayers(uname,id){
                $("#players").html("");
                $.get("/users/getCharacters.py?username="+uname, function(dta){
                        dta = JSON.parse(dta)
                        for(i=0; i < dta.length; i++){
                            console.log(id+" - "+dta[i]["id"])
                            if(dta[i]["id"] == id){
                                $("#players").append("<li class='playerShow'><span class='charactername'>"+dta[i]["name"]+"</span><span class='class'>("+dta[i]["class"].charAt(0).toUpperCase()+")</span><span class='playeruname'><ins>&nbsp;&nbsp;|&nbsp;&nbsp;"+uname+"</ins></span></li>");
                                players.push(data);
                                console.log("joined")
                            }
                        }
                    });
            }

            socket.on("playerJoined", function(data) {
                for(i=0; i < data.length; i++){
                    var index = i
                    console.log(data[i])
                    getCharacterPlayers(data[i][0],data[i][1]);
                }
            });
            $(document).on("mouseenter", ".playerShow", function() {
                $(this).find(".playeruname").show()
            });

            $(document).on("mouseleave", ".playerShow", function() {
                $(this).find(".playeruname").hide()
            });
            $("#chatContainer").draggable({handle:'#chatHeader', grid: [ 10, 10 ] });
            $("#partyStatus").draggable({handle:'#partyHeader', grid: [ 10, 10 ] });
            
            function ex(){
                socket.emit("disconnect");
            }
        </script>
    </body>
</html>